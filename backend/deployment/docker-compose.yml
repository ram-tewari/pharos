# Neo Alexandria 2.0 - Docker Compose Configuration
# Production-ready setup with PostgreSQL and Redis

version: '3.8'

services:
  # Redis Cache & Message Broker (PostgreSQL uses existing host database)
  redis:
    image: redis:7-alpine
    container_name: neo-alexandria-redis
    command: redis-server --appendonly yes
    volumes:
      - redis_data:/data
    ports:
      - "6379:6379"
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - neo-network

  # Backend API
  backend:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: neo-alexandria-backend
    environment:
      # Database (using host PostgreSQL on port 5432)
      DATABASE_URL: postgresql://placeholder
      POSTGRES_SERVER: host.docker.internal
      POSTGRES_USER: ${POSTGRES_USER:-neo_user}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-neo_password}
      POSTGRES_DB: ${POSTGRES_DB:-neo_alexandria}
      POSTGRES_PORT: 5432
      
      # Redis
      REDIS_HOST: redis
      REDIS_PORT: 6379
      CELERY_BROKER_URL: redis://redis:6379/0
      CELERY_RESULT_BACKEND: redis://redis:6379/1
      
      # JWT Authentication
      JWT_SECRET_KEY: ${JWT_SECRET_KEY:-change-this-in-production-please-use-strong-secret}
      JWT_ALGORITHM: HS256
      JWT_ACCESS_TOKEN_EXPIRE_MINUTES: 30
      JWT_REFRESH_TOKEN_EXPIRE_DAYS: 7
      
      # OAuth2 (Optional - configure if needed)
      GOOGLE_CLIENT_ID: ${GOOGLE_CLIENT_ID:-}
      GOOGLE_CLIENT_SECRET: ${GOOGLE_CLIENT_SECRET:-}
      GITHUB_CLIENT_ID: ${GITHUB_CLIENT_ID:-}
      GITHUB_CLIENT_SECRET: ${GITHUB_CLIENT_SECRET:-}
      
      # Rate Limiting
      RATE_LIMIT_FREE_TIER: 100
      RATE_LIMIT_PREMIUM_TIER: 1000
      RATE_LIMIT_ADMIN_TIER: 0
      
      # Environment
      ENV: prod
      TEST_MODE: false
      
      # Advanced RAG (Enable chunking on resource creation)
      CHUNK_ON_RESOURCE_CREATE: true
      CHUNKING_STRATEGY: semantic
      CHUNK_SIZE: 500
      CHUNK_OVERLAP: 50
      GRAPH_EXTRACTION_ENABLED: true
      GRAPH_EXTRACT_ON_CHUNK: true
      SYNTHETIC_QUESTIONS_ENABLED: false
      DEFAULT_RETRIEVAL_STRATEGY: parent-child
    volumes:
      - ./storage:/app/storage
      - ./data:/app/data
      - ./logs:/app/logs
    ports:
      - "8000:8000"
    depends_on:
      redis:
        condition: service_healthy
    extra_hosts:
      - "host.docker.internal:host-gateway"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    networks:
      - neo-network
    restart: unless-stopped

  # Celery Worker (for async tasks)
  celery-worker:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: neo-alexandria-celery
    command: celery -A app.tasks.celery_app worker --loglevel=info
    environment:
      # Same environment as backend (using host PostgreSQL)
      DATABASE_URL: postgresql://placeholder
      POSTGRES_SERVER: host.docker.internal
      POSTGRES_USER: ${POSTGRES_USER:-neo_user}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-neo_password}
      POSTGRES_DB: ${POSTGRES_DB:-neo_alexandria}
      POSTGRES_PORT: 5432
      REDIS_HOST: redis
      REDIS_PORT: 6379
      CELERY_BROKER_URL: redis://redis:6379/0
      CELERY_RESULT_BACKEND: redis://redis:6379/1
      ENV: prod
      CHUNK_ON_RESOURCE_CREATE: true
      GRAPH_EXTRACTION_ENABLED: true
    volumes:
      - ./storage:/app/storage
      - ./data:/app/data
      - ./logs:/app/logs
    depends_on:
      - redis
      - backend
    extra_hosts:
      - "host.docker.internal:host-gateway"
    networks:
      - neo-network
    restart: unless-stopped

volumes:
  redis_data:
    driver: local

networks:
  neo-network:
    driver: bridge
